sudo: required
language: node_js
node_js:
  - 'lts/*'
script:
  - yarn test-coverage
services:
  - docker
env:
  global:
    DOCKER_TAG: dex-telegram
    DOCKER_IMAGE: gnosispm/dex-telegram
cache:
  directories:
    - docker_images
before_install:
  - docker load -i docker_images/images.tar || true
before_cache:
  - docker save -o docker_images/images.tar $(docker images -a -q)
install:
  - yarn install
  - docker build --cache-from $CACHE_IMAGE:develop -t $DOCKER_TAG .
after_success:
  - |
    # Create Docker image if branch master or develop or a tag
    if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
      echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin;

      PACKAGE_VERSION=$(node -p -e "require('./package.json').version");
      echo "Pushing to Docker-hub version $PACKAGE_VERSION, generated from branch $TRAVIS_BRANCH";

      if [ "$TRAVIS_BRANCH" == "master" ]; then
        echo "Pushing image staging...";
        docker tag $DOCKER_TAG $DOCKER_IMAGE:staging;
        docker push $DOCKER_IMAGE:staging;
      elif [ "$TRAVIS_BRANCH" == "develop" ]; then
        echo "Pushing image develop...";
        docker tag $DOCKER_TAG $DOCKER_IMAGE:develop;
        docker push $DOCKER_IMAGE:develop;
      elif [[ $TRAVIS_TAG = $TRAVIS_BRANCH ]]; then
        echo "Pushing image tag $TRAVIS_TAG...";
        docker tag $DOCKER_TAG $DOCKER_IMAGE:$TRAVIS_TAG;
        docker push $DOCKER_IMAGE:$TRAVIS_TAG;
      fi
      echo "The image has been pushed";
    else
      echo "There's no need to push the image to Docker-hub";
    fi
